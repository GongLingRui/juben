---
alwaysApply: true
---
# Python 项目代码规范与最佳实践

## 1. 代码风格规范

### 1.1 格式与布局
- **缩进**: 统一使用 4 个空格，禁止使用 Tab 字符
- **行宽**: 每行代码不超过 79 个字符，注释不超过 72 个字符
- **空行**: 
  - 顶层函数和类定义之间用两个空行
  - 类内方法定义之间用一个空行
  - 函数内逻辑段落之间用一个空行
- **导入顺序**:
  1. 标准库导入
  2. 第三方库导入  
  3. 本地模块导入
- 每组导入之间用空行分隔，按字母顺序排列

### 1.2 命名约定
- **变量和函数**: 使用 snake_case 命名法
- **类名**: 使用 PascalCase 命名法
- **常量**: 使用 UPPER_SNAKE_CASE 命名法
- **私有成员**: 以下划线开头，如 _private_var
- **避免的命名**: 单字符变量名（除了循环计数器）、模糊的缩写

## 2. 代码组织与结构

### 2.1 模块设计原则
- 每个模块应专注于单一职责
- 模块大小适中，通常不超过 500 行
- 避免循环导入依赖
- 使用 __init__.py 文件明确定义包接口

### 2.2 函数设计规范
- 函数长度控制在 50 行以内
- 函数参数不超过 5 个，过多时考虑使用对象封装
- 函数应专注于单一功能，避免副作用
- 使用类型注解明确参数和返回值类型

### 2.3 类设计原则
- 遵循单一职责原则
- 使用组合优于继承
- 类方法应明确其作用域（实例方法、类方法、静态方法）
- 避免过深的继承层次

## 3. 文档与注释标准

### 3.1 文档字符串规范
所有公共模块、类、函数和方法都必须包含文档字符串：

```python
def calculate_statistics(data: List[float], method: str = "mean") -> float:
    """
    计算数据的统计指标。
    
    Args:
        data: 数值数据列表
        method: 统计方法，支持 'mean', 'median', 'mode'
    
    Returns:
        计算得到的统计值
        
    Raises:
        ValueError: 当 method 参数不合法时
        StatisticsError: 当数据无法计算统计值时
    """
    # 实现代码
```

### 3.2 注释指南
- 注释要解释"为什么"而不是"做什么"
- 避免无意义的注释
- 复杂的算法或业务逻辑必须添加注释
- 临时代码或待办事项使用 TODO: 标签

## 4. 类型注解规范

### 4.1 基本类型注解
```python
from typing import List, Dict, Optional, Union

def process_data(
    items: List[str],
    config: Dict[str, Union[int, float]],
    timeout: Optional[int] = None
) -> bool:
    pass
```

### 4.2 复杂类型提示
- 使用 TypeVar 定义泛型
- 使用 Protocol 定义接口契约
- 复杂数据结构使用 TypedDict 或 dataclass

## 5. 异常处理规范

### 5.1 异常处理原则
- 只捕获具体的异常类型，避免裸露的 except:
- 在合适的层级处理异常
- 记录有意义的错误信息
- 清理资源使用 try-finally 或上下文管理器

### 5.2 自定义异常
```python
class DataValidationError(Exception):
    """数据验证失败异常"""
    
    def __init__(self, message: str, field: str):
        super().__init__(message)
        self.field = field
        self.message = message
```

## 6. 测试代码规范

### 6.1 测试结构
- 测试文件名以 test_ 开头
- 测试类名以 Test 开头
- 测试方法名描述测试行为
- 每个测试只验证一个行为

### 6.2 测试质量
- 测试代码与生产代码同等质量标准
- 避免测试间的依赖
- 使用有意义的断言消息
- 覆盖正常、边界和异常情况

## 7. 性能与内存管理

### 7.1 性能优化原则
- 避免不必要的对象创建
- 使用生成器处理大数据集
- 合理使用缓存机制
- 选择适当的数据结构

### 7.2 资源管理
- 文件操作使用 with 语句
- 数据库连接及时关闭
- 大对象显式释放引用
- 使用内存分析工具定期检查

## 8. 安全编码规范

### 8.1 输入验证
- 对所有外部输入进行验证
- 使用白名单验证机制
- 防范注入攻击
- 敏感数据不记录日志

### 8.2 安全实践
- 避免硬编码密码和密钥
- 使用安全的随机数生成器
- 及时更新依赖库的安全补丁

## 9. 工具与自动化

### 9.1 代码质量工具
- 使用 black 进行自动格式化
- 使用 isort 整理导入顺序
- 使用 flake8 进行代码检查
- 使用 mypy 进行类型检查

### 9.2 预提交检查
配置预提交钩子，在提交前自动运行：
- 代码格式化检查
- 静态类型检查
- 单元测试执行
- 安全漏洞扫描

## 10. 配置与环境管理

### 10.1 配置分离
- 代码与配置分离
- 敏感信息使用环境变量
- 不同环境使用不同配置文件
- 配置验证启动时完成

### 10.2 依赖管理
- 使用 requirements.txt 或 Poetry 管理依赖
- 固定依赖版本确保一致性
- 定期更新依赖版本
- 分离开发和生产依赖

## 11. 日志规范

### 11.1 日志级别
- DEBUG: 调试信息
- INFO: 正常操作信息
- WARNING: 警告信息
- ERROR: 错误信息
- CRITICAL: 严重错误

### 11.2 日志格式
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
```

## 12. 代码审查清单

### 12.1 功能质量
- 代码功能完整实现
- 边界情况正确处理
- 错误处理完善
- 性能符合要求

### 12.2 代码质量
- 符合 PEP 8 规范
- 类型注解完整
- 文档字符串齐全
- 单元测试覆盖
- 无安全漏洞

通过遵循这些代码规范，团队可以确保代码质量的一致性，提高开发效率，降低维护成本。所有团队成员都应熟悉并遵守这些规范，并在代码审查中严格执行。